<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yaojun&#39;s Blog">
    <meta name="keyword"  content="Yaojun">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          kubernete集群搭建与安装部署(v1.11.0) - Yaojun&#39;s Blog
        
    </title>

    <link rel="canonical" href="http://yoursite-url/2018/07/24/kubernetes-install/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('Demo.png')
            /*post*/
        
    }
    
    #signature{
        background-image: url('/img/signature/BeanTechSign-white.png');
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Docker" title="Docker">Docker</a>
                            
                              <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                            
                        </div>
                        <h1>kubernete集群搭建与安装部署(v1.11.0)</h1>
                        <h2 class="subheading">全手工从0到1搭建一个kubernete集群，使用版本v1.11.0</h2>
                        <span class="meta">
                            Posted by Yaojun Yu on
                            2018-07-24
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">YaoJun&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <blockquote>
<p>全手工从0到1搭建一个kubernete集群，使用版本v1.11.0完成</p>
</blockquote>
<h1><span id="项目介绍">项目介绍</span></h1>
<p>该文档描述了全手工从0到1搭建一个kubernete集群，使用版本v1.11.0完成。</p>
<h1><span id="软件架构">软件架构</span></h1>
<p>软件架构说明</p>
<h1><span id="安装教程">安装教程</span></h1>
<h2><span id="动手之前">动手之前</span></h2>
<ul>
<li>构建自己的私有镜像仓库</li>
<li>准备机器和设置网络</li>
<li>设置免密登录</li>
<li>关闭防火墙和SELinux</li>
<li>下载安装最新docker引擎</li>
<li>设定系统相关参数</li>
<li>下载安装kubectl，kubelet，cni plugin，cfssl工具</li>
</ul>
<h3><span id="构建自己的私有镜像仓库">构建自己的私有镜像仓库</span></h3>
<p><a href="http://xn--k8s-xi9d497hlzi6vo0hsc4ai32gmox.gcr.io" target="_blank" rel="noopener">由于网络无法访问k8s.gcr.io</a>,gcr.io等镜像仓库原因，首先需要将k8s安装需要的镜像拉取过来，可以使用国内阿里云镜像，登录阿里云控制台搜索镜像，一般都能找到想要的镜像。登录阿里云创建自己的镜像仓库，并拉取开源镜像后上传。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login --username=&#123;YOUR_NAME&#125; registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> k8s-1.11.x/scripts/aliyun-push-kubeimages-1.11.0.sh</span><br><span class="line">FROM_REGISTRY=registry.cn-hangzhou.aliyuncs.com/openthings</span><br><span class="line">TO_REGISTRY=registry.cn-hangzhou.aliyuncs.com/junchen</span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">echo "=========================================================="</span><br><span class="line">echo "Pull Kubernetes 1.11.0 Images from aliyuncs.com ......"</span><br><span class="line">echo "=========================================================="</span><br><span class="line">echo ""</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span># 拉取镜像</span><br><span class="line">docker pull $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-apiserver-amd64:v1.11.0</span><br><span class="line">docker pull $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-controller-manager-amd64:v1.11.0</span><br><span class="line">docker pull $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-scheduler-amd64:v1.11.0</span><br><span class="line">docker pull $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-proxy-amd64:v1.11.0</span><br><span class="line">docker pull $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-etcd-amd64:3.2.18</span><br><span class="line">docker pull $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-pause-amd64:3.1</span><br><span class="line">docker pull docker.io/googlecontainer/defaultbackend-amd64:1.4</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/kube_containers/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/mirrorgoogle/nginx-ingress-controller:0.16.2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span># 添加Tag</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-apiserver-amd64:v1.11.0 $&#123;TO_REGISTRY&#125;/kube-apiserver-amd64:v1.11.0</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-scheduler-amd64:v1.11.0 $&#123;TO_REGISTRY&#125;/kube-scheduler-amd64:v1.11.0</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-controller-manager-amd64:v1.11.0 $&#123;TO_REGISTRY&#125;/kube-controller-manager-amd64:v1.11.0</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-kube-proxy-amd64:v1.11.0 $&#123;TO_REGISTRY&#125;/kube-proxy-amd64:v1.11.0</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-etcd-amd64:3.2.18 $&#123;TO_REGISTRY&#125;/etcd-amd64:3.2.18</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-pause-amd64:3.1 $&#123;TO_REGISTRY&#125;/pause-amd64:3.1</span><br><span class="line">docker tag $&#123;FROM_REGISTRY&#125;/k8s-gcr-io-coredns:1.1.3 $&#123;TO_REGISTRY&#125;/coredns:1.1.3</span><br><span class="line">docker tag docker.io/googlecontainer/defaultbackend-amd64:1.4 $&#123;TO_REGISTRY&#125;/defaultbackend:1.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/kube_containers/kubernetes-dashboard-amd64:v1.8.3 $&#123;TO_REGISTRY&#125;/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/mirrorgoogle/nginx-ingress-controller:0.16.2 $&#123;TO_REGISTRY&#125;/nginx-ingress-controller:0.16.2</span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">echo "=========================================================="</span><br><span class="line">echo "Pull Kubernetes 1.11.0 Images FINISHED."</span><br><span class="line">echo "into registry.cn-hangzhou.aliyuncs.com/openthings, "</span><br><span class="line">echo "           by openthings@https://my.oschina.net/u/2306127."</span><br><span class="line">echo "=========================================================="</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span># 上传镜像</span><br><span class="line">echo ""</span><br><span class="line">echo "=========================================================="</span><br><span class="line">echo "Push Kubernetes 1.11.0 Images to $&#123;TO_REGISTRY&#125;."</span><br><span class="line">echo "=========================================================="</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/kube-apiserver-amd64:v1.11.0</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/kube-scheduler-amd64:v1.11.0</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/kube-controller-manager-amd64:v1.11.0</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/kube-proxy-amd64:v1.11.0</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/etcd-amd64:3.2.18</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/pause-amd64:3.1</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/coredns:1.1.3</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/defaultbackend:1.4</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">docker push $&#123;TO_REGISTRY&#125;/nginx-ingress-controller:0.16.2</span><br><span class="line">echo ""</span><br><span class="line">echo "=========================================================="</span><br><span class="line">echo "Push Kubernetes 1.11.0 Images FINISHED."</span><br><span class="line">echo "=========================================================="</span><br></pre></td></tr></table></figure>
<h3><span id="准备机器和网络">准备机器和网络</span></h3>
<p>kubernetes部署版本信息：</p>
<ul>
<li>Kubernetes: v1.11.0</li>
<li>CNI: v0.7.1</li>
<li>Etcd: v3.3.8</li>
<li>Docker: v18.06.0-ce</li>
<li>Calico: v3.1</li>
</ul>
<p>Kubernetes 部署的網路資訊：</p>
<ul>
<li><strong>Cluster IP CIDR</strong>: 10.244.0.0/16</li>
<li><strong>Service Cluster IP CIDR</strong>: 10.96.0.0/12</li>
<li><strong>Service DNS IP</strong>: 10.96.0.10</li>
<li><strong>DNS DN</strong>: cluster.local</li>
<li><strong>Kubernetes API VIP</strong>: 192.168.1.9</li>
<li><strong>Kubernetes Ingress VIP</strong>: 192.168.1.8</li>
</ul>
<p>部署节点信息如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">IP Address</th>
<th style="text-align:center">Host Name</th>
<th style="text-align:center">CPU</th>
<th style="text-align:center">Mem</th>
<th style="text-align:center">DISK</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.1.10<br>192.168.1.9</td>
<td style="text-align:center">k8s-m1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4G</td>
<td style="text-align:center">10G</td>
<td style="text-align:center">master节点1</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.11<br>192.168.1.9</td>
<td style="text-align:center">k8s-m2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4G</td>
<td style="text-align:center">10G</td>
<td style="text-align:center">master节点2</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.12<br>192.168.1.9</td>
<td style="text-align:center">k8s-m3</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4G</td>
<td style="text-align:center">10G</td>
<td style="text-align:center">master节点3</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.20</td>
<td style="text-align:center">k8s-n1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4G</td>
<td style="text-align:center">10G</td>
<td style="text-align:center">node节点1</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.21</td>
<td style="text-align:center">k8s-n2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4G</td>
<td style="text-align:center">10G</td>
<td style="text-align:center">node节点2</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.22</td>
<td style="text-align:center">k8s-n3</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4G</td>
<td style="text-align:center">10G</td>
<td style="text-align:center">node节点3</td>
</tr>
</tbody>
</table>
<h3><span id="设置免密登录">设置免密登录</span></h3>
<p>在所有节点上设置hosts，使用节点名能访问到机器。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/hosts</span><br><span class="line">192.168.1.10 k8s-m1</span><br><span class="line">192.168.1.11 k8s-m2</span><br><span class="line">192.168.1.12 k8s-m3</span><br><span class="line">192.168.1.20 k8s-n1</span><br><span class="line">192.168.1.21 k8s-n2</span><br><span class="line">192.168.1.22 k8s-n3</span><br></pre></td></tr></table></figure>
<p>在所有节点上修改hostname</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hostnamectl --static <span class="built_in">set</span>-hostname k8s-*</span><br></pre></td></tr></table></figure>
<p>在<code>k8s-m1</code>节点上运行如下脚本，设置免密登录到其他所有机器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">for NODE in k8s-m1 k8s-m2 k8s-m3 k8s-n1 k8s-n2 k8s-n3; do</span><br><span class="line">    ssh-copy-id -i ~/.ssh/id_rsa.pub root@$&#123;NODE&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>执行如下命令验证是否可以免密登录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@k8s-m2</span><br></pre></td></tr></table></figure>
<h3><span id="关闭防火墙和selinux">关闭防火墙和SELinux</span></h3>
<ul>
<li>确认所有节点防火墙和SELinux已关闭</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">$ setenforce 0</span><br><span class="line">$ vi /etc/selinux/config</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<h3><span id="下载安装最新docker引擎">下载安装最新docker引擎</span></h3>
<ul>
<li>确认所有节点安装最新版的docker ce版本引擎并启动</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://get.docker.com/ | sh</span><br><span class="line">$ systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure>
<h3><span id="设定系统相关参数">设定系统相关参数</span></h3>
<ul>
<li><code>所有节点</code>启用网络参数：<code>net.ipv4.ip_forward</code> <code>net.bridge.bridge-nf-call-ip6tables</code> <code>net.bridge.bridge-nf-call-iptables</code>。关于<code>bridge-nf-call-iptables</code>的启用取决于是否将容器连接到<code>Linux bridge</code>或使用其他一些机制(如 SDN vSwitch)。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF | tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>基于性能考虑，Kubernetes v1.8+ 要求关闭系统 Swap，請在<code>所有节点</code>利用以下指令关闭：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">$ sed <span class="string">'/swap.img/d'</span> -i /etc/fstab <span class="comment"># 不同机器会有差别，或者</span></span><br><span class="line">$ sed -i <span class="string">'s/\(^.*centos-swap swap.*$\)/#\1/'</span> /etc/fstab</span><br></pre></td></tr></table></figure>
<h3><span id="下载安装kubectlkubeletcni-plugincfssl工具">下载安装kubectl，kubelet，cni plugin，cfssl工具</span></h3>
<ul>
<li>在<code>所有节点</code>下载安装kubelet</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> KUBE_URL=https://storage.googleapis.com/kubernetes-release/release/v1.11.0/bin/linux/amd64</span><br><span class="line">$ wget <span class="variable">$&#123;KUBE_URL&#125;</span>/kubelet -O /usr/<span class="built_in">local</span>/bin/kubelet</span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/kubelet</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>所有master节点</code>下载安装kubectl</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget <span class="variable">$&#123;KUBE_URL&#125;</span>/kubectl -O /usr/<span class="built_in">local</span>/bin/kubectl</span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/kubectl</span><br></pre></td></tr></table></figure>
<ul>
<li>在所有节点下载安装cni plugin</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> CNI_URL=https://github.com/containernetworking/plugins/releases/download</span><br><span class="line">$ mkdir -p /opt/cni/bin &amp;&amp; <span class="built_in">cd</span> /opt/cni/bin</span><br><span class="line">$ wget <span class="string">"<span class="variable">$&#123;CNI_URL&#125;</span>/v0.7.1/cni-plugins-amd64-v0.7.1.tgz"</span> | tar -zxfv</span><br></pre></td></tr></table></figure>
<ul>
<li>在k8s-m1节点下载安装cfss工具，用于生成各种证书</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> CFSSL_URL=https://pkg.cfssl.org/R1.2</span><br><span class="line">$ wget <span class="variable">$&#123;CFSSL_URL&#125;</span>/cfssl_linux-amd64 -O /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line">$ wget <span class="variable">$&#123;CFSSL_URL&#125;</span>/cfssljson_linux-amd64 -O /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/cfssl /usr/<span class="built_in">local</span>/bin/cfssljson</span><br></pre></td></tr></table></figure>
<h2><span id="设置tls认证建立ca并生成tls证书">设置TLS认证，建立CA并生成TLS证书</span></h2>
<p>Kubernete节点中etcd，apiserver，kubelet等之间采用安全认证通信，将需要生成自签署的安全证书用于认证。生成凭证使用cfssl工具，各证书配置文档可以从git中拉取，JSON配置文件都放在pki文件夹下。各节点需要的证书如下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">CA&amp;Key</th>
<th style="text-align:center">etcd</th>
<th style="text-align:center">kube-apiserver</th>
<th style="text-align:center">kube-proxy</th>
<th style="text-align:center">kubelet</th>
<th style="text-align:center">kubectl</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ca.pem</td>
<td style="text-align:center">√</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ca-key.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">etcd.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">etcd-key.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">kubernetes.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">kubernetes-key.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">kube-proxy.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">kube-proxy-key.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">admin.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">admin-key.pem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/kairen/k8s-manual-files.git ~/k8s-manual-files</span><br><span class="line">$ <span class="built_in">cd</span> ~/k8s-manual-files/pki</span><br></pre></td></tr></table></figure>
<blockquote></blockquote>
<h3><span id="创建ca证书">创建CA证书</span></h3>
<p>配置ca信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vi ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>容器相关证书类型</p>
<p>client auth： 用于服务端认证客户端</p>
<p>server auth: 服务端使用，客户端以此验证服务端身份</p>
<p>client auth &amp; server auth : 双向证书，如用于etcd集群成员间通信</p>
<p>这里配置一种证书类型kubernetes，为双向认证证书，有效期为87600h即10年。</p>
</blockquote>
<p>配置ca-csr</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vi ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes-manual"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>CN和O会影响kubernetes各组件之间的认证，注意在多个配置文件中保持一致</p>
</blockquote>
<p>生成CA证书</p>
<p>在节点<code>k8s-m1</code>生成文件夹<code>/etc/kubernetes/pki</code>，用来存放生成的证书。这里生成ca证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> K8S_DIR=/etc/kubernetes</span><br><span class="line">$ <span class="built_in">export</span> PKI_DIR=<span class="variable">$&#123;K8S_DIR&#125;</span>/pki</span><br><span class="line">$ mkdir -p <span class="variable">$&#123;PKI_DIR&#125;</span></span><br><span class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/ca</span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/ca*.pem</span><br><span class="line">/etc/kubernetes/pki/ca-key.pem  /etc/kubernetes/pki/ca.pem</span><br></pre></td></tr></table></figure>
<h3><span id="签发etcd证书">签发ETCD证书</span></h3>
<p>在<code>k8s-m1</code>建立<code>/etc/etcd/ssl</code>文件夹，生成etcd需要的凭证。</p>
<p>生成etcd ca</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ vi etcd-ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Etcd Security"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">$ <span class="built_in">export</span> DIR=/etc/etcd/ssl</span><br><span class="line">$ mkdir -p <span class="variable">$&#123;DIR&#125;</span></span><br><span class="line">$ cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare <span class="variable">$&#123;DIR&#125;</span>/etcd-ca</span><br></pre></td></tr></table></figure>
<p>生成etcd证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ vi etcd-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Etcd Security"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">$ cfssl gencert \</span><br><span class="line">  -ca=<span class="variable">$&#123;DIR&#125;</span>/etcd-ca.pem \</span><br><span class="line">  -ca-key=<span class="variable">$&#123;DIR&#125;</span>/etcd-ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -hostname=127.0.0.1,192.168.1.10,192.168.1.11,192.168.1.12 \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  etcd-csr.json | cfssljson -bare <span class="variable">$&#123;DIR&#125;</span>/etcd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hostname需要设置所有master节点。</p>
<p>profile为ca-config.json中设定的profile。</p>
</blockquote>
<p>删除不必要的csr文档，并查看是否生成证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf <span class="variable">$&#123;DIR&#125;</span>/*.csr</span><br><span class="line">$ ls /etc/etcd/ssl</span><br><span class="line">etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem</span><br></pre></td></tr></table></figure>
<p>复制证书到其他master节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-m2 k8s-m3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    ssh <span class="variable">$&#123;NODE&#125;</span> <span class="string">" mkdir -p /etc/etcd/ssl"</span></span><br><span class="line">    <span class="keyword">for</span> FILE <span class="keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; <span class="keyword">do</span></span><br><span class="line">      scp /etc/etcd/ssl/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$&#123;NODE&#125;</span>:/etc/etcd/ssl/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h3><span id="api-server">API SERVER</span></h3>
<p>生成API Server与kubelet client之间进行通信的证书。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert \</span><br><span class="line">  -ca=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">  -ca-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -hostname=10.96.0.1,192.168.1.9,127.0.0.1,kubernetes.default \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  apiserver-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/apiserver</span><br><span class="line"></span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/apiserver*.pem</span><br><span class="line">/etc/kubernetes/pki/apiserver-key.pem  /etc/kubernetes/pki/apiserver.pem</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里<code>-hostname</code>的<code>10.96.0.1</code>是cluster IP，<code>192.168.1.9</code>是访问master的集群VIP，<code>kubernetes.default</code>是Kubernetes在 default namespace 自动建立的 API service domain name。</p>
</blockquote>
<h3><span id="front-proxy-client">Front Proxy Client</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/front-proxy-ca</span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/front-proxy-ca*.pem</span><br><span class="line">/etc/kubernetes/pki/front-proxy-ca-key.pem  /etc/kubernetes/pki/front-proxy-ca.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert \</span><br><span class="line">  -ca=<span class="variable">$&#123;PKI_DIR&#125;</span>/front-proxy-ca.pem \</span><br><span class="line">  -ca-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/front-proxy-ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  front-proxy-client-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/front-proxy-client</span><br><span class="line"></span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/front-proxy-client*.pem</span><br><span class="line">/etc/kubernetes/pki/front-proxy-client-key.pem  /etc/kubernetes/pki/front-proxy-client.pem</span><br></pre></td></tr></table></figure>
<h3><span id="controller-manager">Controller Manager</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert \</span><br><span class="line">  -ca=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">  -ca-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  manager-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/controller-manager</span><br><span class="line"></span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/controller-manager*.pem</span><br><span class="line">/etc/kubernetes/pki/controller-manager-key.pem  /etc/kubernetes/pki/controller-manager.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">    --certificate-authority=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/controller-manager.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials system:kube-controller-manager \</span><br><span class="line">    --client-certificate=<span class="variable">$&#123;PKI_DIR&#125;</span>/controller-manager.pem \</span><br><span class="line">    --client-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/controller-manager-key.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/controller-manager.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/controller-manager.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/controller-manager.conf</span><br></pre></td></tr></table></figure>
<h3><span id="scheduler">Scheduler</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert \</span><br><span class="line">  -ca=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">  -ca-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  scheduler-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/scheduler</span><br><span class="line"></span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/scheduler*.pem</span><br><span class="line">/etc/kubernetes/pki/scheduler-key.pem  /etc/kubernetes/pki/scheduler.pem</span><br></pre></td></tr></table></figure>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">    --certificate-authority=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/scheduler.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials system:kube-scheduler \</span><br><span class="line">    --client-certificate=<span class="variable">$&#123;PKI_DIR&#125;</span>/scheduler.pem \</span><br><span class="line">    --client-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/scheduler-key.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/scheduler.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context system:kube-scheduler@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-scheduler \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/scheduler.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/scheduler.conf</span><br></pre></td></tr></table></figure>
<h3><span id="admin">Admin</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert \</span><br><span class="line">  -ca=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">  -ca-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  admin-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/admin</span><br><span class="line"></span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/admin*.pem</span><br><span class="line">/etc/kubernetes/pki/admin-key.pem  /etc/kubernetes/pki/admin.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">    --certificate-authority=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/admin.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials kubernetes-admin \</span><br><span class="line">    --client-certificate=<span class="variable">$&#123;PKI_DIR&#125;</span>/admin.pem \</span><br><span class="line">    --client-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/admin-key.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/admin.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context kubernetes-admin@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=kubernetes-admin \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/admin.conf</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes \</span><br><span class="line">    --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/admin.conf</span><br></pre></td></tr></table></figure>
<h3><span id="masters-kubelet">Masters Kubelet</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-m1 k8s-m2 k8s-m3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    cp kubelet-csr.json kubelet-<span class="variable">$NODE</span>-csr.json;</span><br><span class="line">    sed -i <span class="string">"s/\$NODE/<span class="variable">$NODE</span>/g"</span> kubelet-<span class="variable">$NODE</span>-csr.json;</span><br><span class="line">    cfssl gencert \</span><br><span class="line">      -ca=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span><br><span class="line">      -ca-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=<span class="variable">$NODE</span> \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kubelet-<span class="variable">$NODE</span>-csr.json | cfssljson -bare <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-<span class="variable">$NODE</span>;</span><br><span class="line">    rm kubelet-<span class="variable">$NODE</span>-csr.json</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet*.pem</span><br><span class="line">/etc/kubernetes/pki/kubelet-k8s-m1-key.pem  /etc/kubernetes/pki/kubelet-k8s-m2.pem</span><br><span class="line">/etc/kubernetes/pki/kubelet-k8s-m1.pem      /etc/kubernetes/pki/kubelet-k8s-m3-key.pem</span><br><span class="line">/etc/kubernetes/pki/kubelet-k8s-m2-key.pem  /etc/kubernetes/pki/kubelet-k8s-m3.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-m1 k8s-m2 k8s-m3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    ssh <span class="variable">$&#123;NODE&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;PKI_DIR&#125;</span>"</span></span><br><span class="line">    scp <span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem <span class="variable">$&#123;NODE&#125;</span>:<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem</span><br><span class="line">    scp <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-<span class="variable">$NODE</span>-key.pem <span class="variable">$&#123;NODE&#125;</span>:<span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-key.pem</span><br><span class="line">    scp <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-<span class="variable">$NODE</span>.pem <span class="variable">$&#123;NODE&#125;</span>:<span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet.pem</span><br><span class="line">    rm <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-<span class="variable">$NODE</span>-key.pem <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-<span class="variable">$NODE</span>.pem</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-m1 k8s-m2 k8s-m3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    ssh <span class="variable">$&#123;NODE&#125;</span> <span class="string">"cd <span class="variable">$&#123;PKI_DIR&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">      kubectl config set-cluster kubernetes \</span></span><br><span class="line"><span class="string">        --certificate-authority=<span class="variable">$&#123;PKI_DIR&#125;</span>/ca.pem \</span></span><br><span class="line"><span class="string">        --embed-certs=true \</span></span><br><span class="line"><span class="string">        --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span></span><br><span class="line"><span class="string">        --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet.conf &amp;&amp; \</span></span><br><span class="line"><span class="string">      kubectl config set-credentials system:node:<span class="variable">$&#123;NODE&#125;</span> \</span></span><br><span class="line"><span class="string">        --client-certificate=<span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet.pem \</span></span><br><span class="line"><span class="string">        --client-key=<span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet-key.pem \</span></span><br><span class="line"><span class="string">        --embed-certs=true \</span></span><br><span class="line"><span class="string">        --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet.conf &amp;&amp; \</span></span><br><span class="line"><span class="string">      kubectl config set-context system:node:<span class="variable">$&#123;NODE&#125;</span>@kubernetes \</span></span><br><span class="line"><span class="string">        --cluster=kubernetes \</span></span><br><span class="line"><span class="string">        --user=system:node:<span class="variable">$&#123;NODE&#125;</span> \</span></span><br><span class="line"><span class="string">        --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet.conf &amp;&amp; \</span></span><br><span class="line"><span class="string">      kubectl config use-context system:node:<span class="variable">$&#123;NODE&#125;</span>@kubernetes \</span></span><br><span class="line"><span class="string">        --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet.conf"</span></span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h3><span id="service-account-key">Service Account Key</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out <span class="variable">$&#123;PKI_DIR&#125;</span>/sa.key 2048</span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> <span class="variable">$&#123;PKI_DIR&#125;</span>/sa.key -pubout -out <span class="variable">$&#123;PKI_DIR&#125;</span>/sa.pub</span><br><span class="line">$ ls <span class="variable">$&#123;PKI_DIR&#125;</span>/sa.*</span><br><span class="line">/etc/kubernetes/pki/sa.key  /etc/kubernetes/pki/sa.pub</span><br></pre></td></tr></table></figure>
<h3><span id="复制文档到其他节点">复制文档到其他节点</span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf <span class="variable">$&#123;PKI_DIR&#125;</span>/*.csr \</span><br><span class="line">    <span class="variable">$&#123;PKI_DIR&#125;</span>/scheduler*.pem \</span><br><span class="line">    <span class="variable">$&#123;PKI_DIR&#125;</span>/controller-manager*.pem \</span><br><span class="line">    <span class="variable">$&#123;PKI_DIR&#125;</span>/admin*.pem \</span><br><span class="line">    <span class="variable">$&#123;PKI_DIR&#125;</span>/kubelet*.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-m2 k8s-m3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    <span class="keyword">for</span> FILE <span class="keyword">in</span> $(ls <span class="variable">$&#123;PKI_DIR&#125;</span>); <span class="keyword">do</span></span><br><span class="line">      scp <span class="variable">$&#123;PKI_DIR&#125;</span>/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$&#123;NODE&#125;</span>:<span class="variable">$&#123;PKI_DIR&#125;</span>/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-m2 k8s-m3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    <span class="keyword">for</span> FILE <span class="keyword">in</span> admin.conf controller-manager.conf scheduler.conf; <span class="keyword">do</span></span><br><span class="line">      scp <span class="variable">$&#123;K8S_DIR&#125;</span>/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$&#123;NODE&#125;</span>:<span class="variable">$&#123;K8S_DIR&#125;</span>/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2><span id="kubernetes-masters设置">Kubernetes Masters设置</span></h2>
<h2><span id="kubernetes-nodes设置">Kubernetes Nodes设置</span></h2>
<h2><span id="kubernetes-core-addons部署">Kubernetes Core Addons部署</span></h2>
<h2><span id="kubernetes-网络设置">Kubernetes 网络设置</span></h2>
<h2><span id="kubernetes-extra-addons部署">Kubernetes Extra Addons部署</span></h2>
<h1><span id="使用说明">使用说明</span></h1>
<ol>
<li>xxxx</li>
<li>xxxx</li>
<li>xxxx</li>
</ol>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">项目介绍</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">软件架构</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">安装教程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">动手之前</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.1.</span> <span class="toc-nav-text">构建自己的私有镜像仓库</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.2.</span> <span class="toc-nav-text">准备机器和网络</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.3.</span> <span class="toc-nav-text">设置免密登录</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.4.</span> <span class="toc-nav-text">关闭防火墙和SELinux</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.5.</span> <span class="toc-nav-text">下载安装最新docker引擎</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.6.</span> <span class="toc-nav-text">设定系统相关参数</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.7.</span> <span class="toc-nav-text">下载安装kubectl，kubelet，cni plugin，cfssl工具</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">设置TLS认证，建立CA并生成TLS证书</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.1.</span> <span class="toc-nav-text">创建CA证书</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.2.</span> <span class="toc-nav-text">签发ETCD证书</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.3.</span> <span class="toc-nav-text">API SERVER</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.4.</span> <span class="toc-nav-text">Front Proxy Client</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.5.</span> <span class="toc-nav-text">Controller Manager</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.6.</span> <span class="toc-nav-text">Scheduler</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.7.</span> <span class="toc-nav-text">Admin</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.8.</span> <span class="toc-nav-text">Masters Kubelet</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.9.</span> <span class="toc-nav-text">Service Account Key</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.2.10.</span> <span class="toc-nav-text">复制文档到其他节点</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">Kubernetes Masters设置</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">Kubernetes Nodes设置</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.5.</span> <span class="toc-nav-text">Kubernetes Core Addons部署</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.6.</span> <span class="toc-nav-text">Kubernetes 网络设置</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.7.</span> <span class="toc-nav-text">Kubernetes Extra Addons部署</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">使用说明</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Docker" title="Docker">Docker</a>
                        
                          <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://beantech.org" target="_blank">Bean Tech</a></li>
                    
                        <li><a href="http://blog.kaijun.rocks" target="_blank">Kaijun&#39;s Blog</a></li>
                    
                        <li><a href="http://huangxuan.me" target="_blank">Hux Blog</a></li>
                    
                        <li><a href="#" target="_blank">It Helps SEO</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "your-disqus-ID";
    var disqus_identifier = "http://yoursite-url/2018/07/24/kubernetes-install/";
    var disqus_url = "http://yoursite-url/2018/07/24/kubernetes-install/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/yaojunchina@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/YaojunYu">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/yaojunchina@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Yaojun Yu 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org">BeanTech</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://yoursite-url/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yaojunyu.github.io';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="http://yoursite-url/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
